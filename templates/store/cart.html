{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="cart-container">
    <h2>Tu Carrito de Compras</h2>

    {% if not cart or not items %}
        <div class="empty-cart">
            <p>Tu carrito est√° vac√≠o üò¢</p>
            <a href="{% url 'store:home' %}" class="btn-primary">Ir a la Tienda</a>
        </div>
    {% else %}
        <div class="cart-header">
            <div class="col-product">PRODUCTO</div>
            <div class="col-size">TALLE</div>
            <div class="col-price">PRECIO</div>
            <div class="col-qty">CANTIDAD</div>
            <div class="col-total">TOTAL</div>
        </div>

        <div class="cart-items-list">
            {% for item in items %}
            <div class="cart-row">
                <div class="col-product product-info">
                    {% if item.product.image %}
                        <img src="{{ item.product.image.url }}" alt="{{ item.product.name }}">
                    {% else %}
                        <div class="placeholder-img"></div>
                    {% endif %}
                    <span>{{ item.product.name }}</span>
                </div>

                <div class="col-size">
                    <span class="badge">{{ item.stock_item.size.name }}</span>
                </div>

                <div class="col-price">
                    ${{ item.product.price }}
                </div>

                <div class="col-qty">
                    {{ item.quantity }}
                </div>

                <div class="col-total">
                    <strong>${{ item.total_price }}</strong>
                </div>
            </div>
            {% endfor %}
        </div>

        <div class="cart-summary">
            <p class="timer-warning">
                Ten√©s 15 minutos para completar la compra o tus productos volver√°n a estar disponibles.
                <br>
                Tiempo restante: <span id="cart-timer">15:00</span>
            </p>
            <h3>Total a Pagar: <span>${{ total }}</span></h3>
            
            <div class="cart-actions">
                <a href="{% url 'store:home' %}" class="btn-outline">‚Üê Seguir Comprando</a>
                <a href="{% url 'store:checkout' %}" class="btn-primary">Finalizar Compra</a>
            </div>
        </div>
    {% endif %}
</div>
{% if expiry_timestamp %}
<script>
    (function() {
        const expiryTs = {{ expiry_timestamp|safe }};
        if (!expiryTs) return;
        const timerEl = document.getElementById('cart-timer');
        function updateTimer() {
            const now = Date.now();
            let diff = Math.floor((expiryTs - now) / 1000);
            if (diff <= 0) {
                timerEl.textContent = '00:00';
                // Forzamos recarga para que se libere stock y se vea el carrito vac√≠o
                window.location.reload();
                return;
            }
            const minutes = String(Math.floor(diff / 60)).padStart(2, '0');
            const seconds = String(diff % 60).padStart(2, '0');
            timerEl.textContent = minutes + ':' + seconds;
        }
        updateTimer();
        setInterval(updateTimer, 1000);
    })();
</script>
{% endif %}
{% endblock %}